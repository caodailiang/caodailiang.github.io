---
layout:     post
title:      eBPF技术简介
date:       2022-10-06
author:     caodailiang
header-img: img/post-bg-ios9-web.jpg
catalog: 	 true
tags:
    - eBPF
---

## 基础概念
- 内核虚拟机技术，通过sys_bpf加载到内核中，绑定到事件执行
- 访问内核数据结构和API，如网络数据包、系统调用、内核跟踪点，对数据进行过滤、修改、分析
- 安全性和可验证性，可通过Verifier进行严格检查

## 技术原理和实现
- 字节码，JIT编译器优化，转化为机器码
- 指令集是虚拟机的执行单元，并提供辅助函数来完成内存访问、系统调用和跟踪等
- 传统虚拟机提供用户程序的运行环境，ebpf虚拟机用于增强内核功能

## eBPF程序剖析
#### 事件和钩子
- 系统调用：当用户空间程序通过系统调用执行内核功能时
- 功能的进入和退出：在函数退出之前拦截调用
- 网络事件：当接收到数据包时
- kprobe和uprobe中：挂载到内核或用户函数中

#### 辅助函数
- 让ebpf访问内存的丰富功能，如Helper：
- 在数据表中对键值对进行搜索、更新和删除
- 生成伪随机数
- 搜集和标记隧道元数据
- 把ebpf程序连接起来，也叫tail call
- 执行socket相关任务，如绑定、获取cookie、数据包重定向等

#### map
- 在ebpf程序和内核、用户空间之间存储和共享数据，ebpf程序通过辅助函数在map中发送和接收数据

## 应用场景
- 网络数据包过滤和流量控制：在网络驱动程序中加载ebpf程序
- 系统性能分析和调优：关键代码路径中插入ebpf程序，实时收集系统运行情况和性能指标
- 安全监控和防护：加载ebpf程序到内核中，实时捕获和分析系统行为

## 发展前景
- 社区发展和生态系统
- 云原生和容器技术中的应用
- 挑战和未来发展：安全和性能平衡、开发和调试工具等
